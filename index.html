
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>The Blog of Tyler Russell</title>
  <meta name="author" content="Tyler Russell">

  
  <meta name="description" content="TLDR In part 2 of our series, we will use the map generated in part 1 as the beginning of our Angular2 component.
Our component will consist of three &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://terussell85.github.io">
  <link href="/favicon.ico" rel="icon">
  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="The Blog of Tyler Russell" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-46719174-1']);
    _gaq.push(['_setDomainName','github.io']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="no-sidebar"  >
  <header role="banner"><hgroup>
  
  <h2><a href="/">TR</a></h2>
  
  <h1>The Blog of Tyler Russell</h1>
</hgroup>

</header>
  <nav role="navigation">
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:terussell85.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  
  <li><a href="https://github.com/terussell85" target="_blank">Code</a></li>
  
  
  <li><a href="https://twitter.com/te_russ">Follow Me</a></li>
  
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/21/building-an-angular2-timezone-picker-part-2/">An Angular2 Timezone Picker - Part 2: Exploring the World (of Ng2)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-04-21T23:22:28-06:00" pubdate data-updated="true">Apr 21<span>st</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>TLDR</h3>

<ol>
<li>In part 2 of our series, we will use the map generated in part 1 as the beginning of our Angular2 component.</li>
<li>Our component will consist of three directives that interact together, the TimeZone, TimeZoneMap, and TimeZonePicker.</li>
<li>We will use <code>@Template</code> and <code>@Decorator</code> to build the first of our three components, the TimeZone.</li>
<li>We will use <code>PropertySetter</code> to toggle classes on elements not injected into our directive.</li>
</ol>


<h3>Getting Started</h3>

<p>Welcome back!  Glad to see I didn&rsquo;t scare you off already.</p>

<p>In part 1 of our series, we used Kartograph to build and optimize an SVG map from open source .shp files.  Now that we&rsquo;re in part 2 of our series, congratulations, you&rsquo;re finally going to see some JavaScript.</p>

<p>Well&hellip; kind of.  We&rsquo;re going to be using TypeScript with ES6 structure and modules.  Love it or hate it, it&rsquo;s going to be the defacto way to write Angular2.  No, it&rsquo;s not required.  But I&rsquo;d wager that most tutorials and documentation will be written that way.</p>

<p>If you&rsquo;ve never seen ES6 or TypScript code, take a look <a href="http://www.typescriptlang.org/Tutorial">here</a> and <a href="https://github.com/lukehoban/es6features">here</a>.  That will give you a brief introduction.  We&rsquo;ll be using a small subset of the syntax here, so don&rsquo;t fret if you feel overwhelmed.</p>

<p>We&rsquo;ll use the <a href="https://github.com/swirlycheetah/generator-angular2">Angular2 Yeoman generator</a> as a starting point for our project.  I personally liked the generator better than the &ldquo;Getting Started&rdquo; on <a href="http://www.angular.io">angular.io</a>, but that is not to say that it is perfect.  Once the generator was run, I made a few small tweaks to the file organization, just for my own sake.  In case you are wondering, my beginning file structure looked like the image below.</p>

<div style="text-align:center; margin-bottom:20px;">
    <img src="/images/timezone/structure.jpg" style="max-height:300px">
</div>


<p>Since I updated the file structure, I also had to update a few of the generated files to reflect the changes.  You can see those changes in the code blocks below.</p>

<p>index.html</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!doctype html&gt;</span>
</span><span class='line'><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;head&gt;</span>
</span><span class='line'>    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;X-UA-Compatible&quot;</span> <span class="na">content=</span><span class="s">&quot;IE=edge&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content=</span><span class="s">&quot;width=device-width, initial-scale=1&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;title&gt;</span>My Timezone Picker<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;body&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;my</span><span class="na">-app</span><span class="nt">&gt;</span>Loading...<span class="err">&lt;</span>/my-app&gt;
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;lib/system.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;lib/zone.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;script&gt;</span>
</span><span class='line'>      <span class="nx">System</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">baseURL</span><span class="o">:</span> <span class="s1">&#39;lib/&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="s1">&#39;angular2/*&#39;</span><span class="o">:</span> <span class="s1">&#39;angular2.js&#39;</span><span class="p">,</span>
</span><span class='line'>          <span class="s1">&#39;rx/dist/rx.all&#39;</span><span class="o">:</span> <span class="s1">&#39;rx.all.js&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//updated to point to the newly created components directory</span>
</span><span class='line'>          <span class="s1">&#39;components/*&#39;</span> <span class="o">:</span> <span class="s2">&quot;../components/*.js&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">//import the self-bootstrapping main component</span>
</span><span class='line'>      <span class="nx">System</span><span class="p">.</span><span class="kr">import</span><span class="p">(</span><span class="s1">&#39;components/app/main&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nt">&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>/src/components/app/main.js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">Component</span><span class="p">,</span> <span class="nx">Decorator</span><span class="p">,</span> <span class="nx">Template</span><span class="p">,</span> <span class="nx">bootstrap</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;angular2/angular2&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">TimeZonePicker</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;components/timezonepicker/timezonepicker&#39;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// Annotation section</span>
</span><span class='line'><span class="err">@</span><span class="nx">Component</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">selector</span><span class="o">:</span> <span class="s1">&#39;my-app&#39;</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="err">@</span><span class="nx">Template</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">inline</span><span class="o">:</span> <span class="s1">&#39;Testing&#39;</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="c1">// Component controller</span>
</span><span class='line'><span class="kr">export</span> <span class="kr">class</span> <span class="nx">Main</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">constructor</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//boostrap the component</span>
</span><span class='line'><span class="nx">bootstrap</span><span class="p">(</span><span class="nx">Main</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>A Quick Note on Angular2</h3>

<p>Before we get too far into the weeds, I need to get something out in open&hellip;  I&rsquo;m still an Angular2 n00b.  <em>Whew</em>.  I&rsquo;m glad we got that out of the way.  Otherwise this might have gotten really awkward later on.</p>

<p>Instead of thinking of this an authoritative source regarding how to write Angular2, this of it as a documented learning experience.  It is more of a play-by-play of my own personal adventures as I began learning Angular2 (and continue to learn it).   In future posts, you&rsquo;ll notice me trying a couple of different ways to see which works best.  Despite what most blog posts would have you believe, we make mistakes as we program.  So if you&rsquo;re still learning Angular2, we&rsquo;ll be learning together. If you&rsquo;re an expert, feel free to comment and let me know how to improve.  Feedback is welcome and highly encouraged.</p>

<p>Also, as to be expected of a framework in alpha stages, Angular2 is still the wild wild west of coding. Expect to read source code, design documents, and pull requests as you try to figure things out.  And expect that things are likely to change in the future.  In fact, since beginning this post, a <a href="https://github.com/angular/angular/issues/1244">few</a> <a href="https://github.com/angular/angular/issues/973">open</a> <a href="https://github.com/angular/angular/issues/1239">issues</a> have already changed some fundamental parts of how to write Angular2 directives.  I will try and update once the changes have been made public in the alpha releases.</p>

<p>Even with all those caveats, writing Angular2 code is a lot of fun.  It feels like a combination of the best parts of a lot of different frameworks. I hope you will find that you learn something from my misadventures.  I will attempt to explain some of the speed bumps I&rsquo;ve run into, and some of the lessons that I have learned thus far.  If you feel like my explanation are lacking, and you need more information, <a href="https://github.com/timjacobi/angular2-education">this curated list</a> is probably a good starting point for information on Angular2.</p>

<h3>The Architecture</h3>

<p>Because of it&rsquo;s complexity, we already know that our time zone picker is going to consist of a number of different Angular2 directives working together.</p>

<p>There is one major constraint that we need to keep in mind as we plan our architecture so that we don&rsquo;t code ourselves into a corner. We need to remember that <em>our map is a generated SVG</em>.  This turns out to be very important as we consider how to write our code.  We want to be able to use our map in it&rsquo;s generated form without modifying the SVG code.  This will allow us to regenerate maps with different bounds, timezones, etc without requiring tweaks by hand, or writing some sort of post-processor.</p>

<p>In more specific terms, it means that our Angular2 components need to work with the existing SVG structure of the map.  In traditional directive development, we would be defining the templates.  With our picker, that is almost reversed.  The template is defined, and we are writing directives to assign behavior.  You could do the same thing with AngularJs (v1.x), but it actually feels even slicker doing it in Angular2.  You&rsquo;ll see what I mean as we dig deeper.</p>

<p>Alright, so with that constraint in mind, we know that we will need at least 3 directives:</p>

<ol>
<li>The Time Zone Picker &ndash; this will serve as the container component.  It will provide some behavior, but mostly styling and a wrapper template</li>
<li>The Time Zone Map &ndash; this is the component that will represent our map.  It will coordinate the state across all time zones.</li>
<li>The Time Zone &ndash; this component will serve to assign click behaviors to a time zone in our map.</li>
</ol>


<p>Let&rsquo;s start by creating stubs for each of these directives.</p>

<p>/src/components/timezonepicker.js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">Component</span><span class="p">,</span> <span class="nx">Template</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;angular2/angular2&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">TimeZoneMap</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;components/timezonepicker/timezonemap&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="err">@</span><span class="nx">Component</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">selector</span><span class="o">:</span> <span class="s2">&quot;timezone-picker&quot;</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="err">@</span><span class="nx">Template</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">inline</span><span class="o">:</span> <span class="s2">&quot;&lt;timezone-map&gt;&lt;/timezone-map&gt;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">directives</span><span class="o">:</span> <span class="p">[</span><span class="nx">TimeZoneMap</span><span class="p">]</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="kr">export</span> <span class="kr">class</span> <span class="nx">TimeZonePicker</span><span class="p">{</span>
</span><span class='line'>    <span class="nx">constructor</span><span class="p">(){</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;TimeZonePicker constructed&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>/src/components/timezonemap.js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">Component</span><span class="p">,</span> <span class="nx">Template</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;angular2/angular2&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">TimeZone</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;components/timezonepicker/timezone&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="err">@</span><span class="nx">Component</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">selector</span><span class="o">:</span> <span class="s2">&quot;timezone-map&quot;</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="err">@</span><span class="nx">Template</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;components/timezonepicker/timezonemap.svg&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">directives</span><span class="o">:</span> <span class="p">[</span><span class="nx">TimeZone</span><span class="p">]</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="kr">export</span> <span class="kr">class</span> <span class="nx">TimeZoneMap</span><span class="p">{</span>
</span><span class='line'>    <span class="nx">constructor</span><span class="p">(){</span>
</span><span class='line'>       <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;TimeZoneMap constructed&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>/src/components/timezone.js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">Decorator</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;angular2/angular2&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">PropertySetter</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;angular2/src/core/annotations/di&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="err">@</span><span class="nx">Decorator</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">selector</span><span class="o">:</span> <span class="s1">&#39;[data-tz-id]&#39;</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="kr">export</span> <span class="kr">class</span> <span class="nx">TimeZone</span><span class="p">{</span>
</span><span class='line'>    <span class="nx">constructor</span><span class="p">(){</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;TimeZone constructed&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Pause!</h3>

<p>If you&rsquo;re new to Angular2, those stubs already contain an awful amount of new information.  Here is a crash course:</p>

<h5>&ldquo;import {item} from &lsquo;location&rsquo;</h5>

<p>This is ES6 module syntax for loading dependencies.  Pretty sweet huh?  With ES6, we finally get a proper module syntax baked into the language itself.  The other side of this is the <code>export</code> syntax, which allows us to declare what items are exposed to consumers of our modules.  If you want more information, do a quick Google search for &ldquo;ES6 modules&rdquo;.  Or read about the different aspects of the syntax <a href="http://www.2ality.com/2014/09/es6-modules-final.html">here</a>.  Lot&rsquo;s has been written already, so I won&rsquo;t bother duplicating it.</p>

<h5>@Component, @Template, @Decorator</h5>

<p>These fancy things are called &ldquo;annotations&rdquo;.  They&rsquo;ve been a pivotal part of other languages for a while, and a few JavaScript libraries as well.  Angular2 uses annotations extensively.  Think of them as neat ways to establish metadata.  Annotations are becoming more commonplace in client-side frameworks, so I wouldn&rsquo;t be surprised to see widespread use in JavaScript in the near future.</p>

<p>That being said, annotations are not part of the ES6 spec, and still rely on transpilers to convert them into functional browser code.  But for all you <a href="https://babeljs.io/">babel.js</a> (and equivalent) users out there, don&rsquo;t worry, people are already working on getting the Angular2 annotations supported.</p>

<h5>@Component vs @Decorator</h5>

<p>There are <a href="https://github.com/angular/angular/blob/master/modules/angular2/docs/core/02_directives.md">three types of directives in Angular2</a>, Decorator, Component, and Viewport.  In short, decorators are useful for encapsulating behavior, components are useful for encapsulating behavior and visual state.</p>

<h5>Classes and constructor()</h5>

<p>ES6 provides the <code>class</code> keyword as some nice syntax sugar for OO-style programming in JavaScript.  Constructor functions are part of that syntax sugar.  It is called any time an instance of this class is created.</p>

<p>If you want more information about the class syntax, <a href="http://www.2ality.com/2015/02/es6-classes-final.html">here</a>, <a href="http://www.2ality.com/2013/07/defending-constructors.html">here</a> and <a href="http://www.frontendjournal.com/javascript-es6-learn-important-features-in-a-few-minutes/">here</a> are great starting points.  Otherwise, a few Google searches will get you a ton of information.</p>

<p>Most of the other items in the stub code should be pretty self-explanatory.  The properties of the annotations provide configuration for Angular2 to build and find the components we are creating.</p>

<p>You&rsquo;ll also notice that we use the selector &ldquo;[data-tz-id]&rdquo; in our TimeZone <code>@Decorator</code> annotation.  When we generated our map, we designated that the timezone id should be added to each time zone SVG path with that attribute.  That makes it really easy to create a directive instance for each time zone.</p>

<h3>Back to the show</h3>

<p>Now that we have our stubs, let&rsquo;s make sure it all works.  In <code>/src/components/app/main.js</code> let&rsquo;s change our app component to include a TimeZonePicker in its template.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">//change the template from this</span>
</span><span class='line'><span class="err">@</span><span class="nx">Template</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">inline</span><span class="o">:</span> <span class="s1">&#39;Testing&#39;</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//to this</span>
</span><span class='line'><span class="err">@</span><span class="nx">Template</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">inline</span><span class="o">:</span> <span class="s1">&#39;&lt;timezone-picker&gt;&lt;/timezone-picker&gt;&#39;</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>And let&rsquo;s fire up our component using <code>gulp dev</code>.</p>

<div style="text-align:center; margin-bottom:20px;">
    <img src="/images/timezone/timezonestub_output.jpg" style="max-height: 250px">
</div>


<p>We see that each of the components is being instantiated!  Perfect.  Let&rsquo;s start fleshing them out.</p>

<h3>Make the Time Zones Clickable</h3>

<p>Let&rsquo;s start to add some behavior.  We know that we want the user to be able to click on a time zone and have it be selected.  So let&rsquo;s start there.  In Angular 1.x, we&rsquo;d add an ng-click with a callback.  In standard Angular2, we&rsquo;d probably add something like <code>(click)="doSomething()"</code> to our template.  But remember how we don&rsquo;t want to change the SVG to add properties?  So how in the world can we assign click behavior to the time zone?</p>

<p>Maybe we could inject the current element and add a click listener by hand, that calls a function in the TimeZone.  That is actually very possible in Angular2.   This is actually the way that the Angular2 team does it in a few cases.  If you look at the code for the <a href="https://github.com/angular/angular/blob/master/modules/angular2/src/directives/class.js"><code>class</code> directive</a>, you&rsquo;ll see that you can inject the element in your class constructor.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">Decorator</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;angular2/angular2&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">PropertySetter</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;angular2/src/core/annotations/di&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="err">@</span><span class="nx">Decorator</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">selector</span><span class="o">:</span> <span class="s1">&#39;[data-tz-id]&#39;</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="kr">export</span> <span class="kr">class</span> <span class="nx">TimeZone</span><span class="p">{</span>
</span><span class='line'>    <span class="nx">constructor</span><span class="p">(</span><span class="nx">ngEl</span><span class="o">:</span> <span class="nx">NgElement</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;TimeZone constructed&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_domEl</span> <span class="o">=</span> <span class="nx">ngEl</span><span class="p">.</span><span class="nx">domElement</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">onTimeZoneClick</span><span class="p">(){</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;time zone was clicked!&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As we get started down this path, however, it quickly becomes apparent that this isn&rsquo;t the way we want to go.  It&rsquo;s nice to know this is available, but there must be a simpler way than just adding behavior directly to the DOM element.  Luckily, there it.  If we go back to the documentation for the <a href="https://github.com/angular/angular/blob/master/modules/angular2/docs/core/02_directives.md#decorators"><code>@Decorator</code> directive type</a>, we&rsquo;ll notice a property called <code>events</code>.</p>

<p>The <code>events</code> property allows up to wire up listeners on our host DOM element that are automatically wired to expressions in our directives.  So let&rsquo;s tweak our TimeZone implementation to include the click event and corresponding callback.</p>

<hr style="margin-bottom:20px;">


<p><strong>&mdash;Author Injection&mdash;</strong> Ugh.  This one literally <a href="https://github.com/angular/angular/issues/1244">changed underneath me</a> as I was writing this article.  It looks like it is now <code>hostListeners</code>.  The Angular2 documentation has been updated, but the code hasn&rsquo;t been shipped yet as far as I can tell.  I&rsquo;ll update my examples once the changes ship in the alpha releases.</p>

<hr style="margin-bottom:30px;">


<p>So let&rsquo;s take out our element in the constructor, and wire up the <code>events</code> property of the <code>@Decorator</code> annotation.  We&rsquo;ll also add in a callback function on our TimeZone component to be called when the click happens.  That feels more Angular2-ish that manipulating the DOM element directly.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">Decorator</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;angular2/angular2&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">PropertySetter</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;angular2/src/core/annotations/di&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="err">@</span><span class="nx">Decorator</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">selector</span><span class="o">:</span> <span class="s1">&#39;[data-tz-id]&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">events</span><span class="o">:</span> <span class="p">{</span> <span class="nx">click</span><span class="o">:</span> <span class="s1">&#39;onTimeZoneClick()&#39;</span> <span class="p">}</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="kr">export</span> <span class="kr">class</span> <span class="nx">TimeZone</span><span class="p">{</span>
</span><span class='line'>    <span class="nx">constructor</span><span class="p">(){</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;TimeZone constructed&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">onTimeZoneClick</span><span class="p">(){</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;time zone was clicked!&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Alright, now let&rsquo;s fire up our picker and take a look.  Hmm.  As we click around, you might notice that nothing is happening.  What the heck?  Why isn&rsquo;t it working?  Ah yes, a quick Google search reminds us that <a href="http://stackoverflow.com/questions/11701461/attach-events-to-svg-paths">SVG paths with no fill are not clickable</a>.  I can&rsquo;t tell you how many times I&rsquo;ve had to re-learn that lesson.  We don&rsquo;t have a proper place to add the fill style yet, so let&rsquo;s just make a quick tweak to <code>index.html</code> to add a style tag with the necessary CSS.  We&rsquo;ll come back to styling a few times later.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;style </span><span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">path</span><span class="o">[</span><span class="nt">data-tz-id</span><span class="o">]</span><span class="p">{</span>
</span><span class='line'>    <span class="n">fill</span><span class="o">:</span> <span class="k">transparent</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="nt">&lt;/style&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we&rsquo;re in business.  Our time zone is responding to clicks.  But we still don&rsquo;t know which id corresponds to the time zone shape being clicked.  That information is available in the <code>data-tz-id</code> attribute on the DOM element, but not in our Decorator.  Let&rsquo;s head to the <a href="https://github.com/angular/angular/blob/master/modules/angular2/docs/core/02_directives.md#decorators">documentation</a> one more time.  It looks like directives can specify a <code>bind</code> property to get attributes from the DOM elements.  That sounds like it might fit the bill, so let&rsquo;s give it a try.</p>

<p>On a quasi-related side note, because of the way that Angular2 bindings work, the <code>bind</code> property is actually the same for both static property values and dynamic values from parent directives.  So no more <code>@</code> and <code>=</code> in directive definitions.  The value we get back from <code>bind</code> is the value we can use.  No more need to run $parse or $eval.  Yay!</p>

<hr style="margin-bottom:20px;">


<p><strong>&mdash;Author Injection&mdash;</strong> It looks like <code>bind</code> has also been changed in some recent Angular2 changes. It&rsquo;s new name is <code>properties</code> and has changed from an object to a list.  Again, expect an update in the future to fix the code samples once the changes are published to the alpha releases.</p>

<hr style="margin-bottom:30px;">


<p>In our TimeZone directive, let&rsquo;s add the <code>bind</code> property.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">Decorator</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;angular2/angular2&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">PropertySetter</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;angular2/src/core/annotations/di&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="err">@</span><span class="nx">Decorator</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">selector</span><span class="o">:</span> <span class="s1">&#39;[data-tz-id]&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">bind</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;id&quot;</span> <span class="o">:</span> <span class="s2">&quot;data-tz-id&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="nx">events</span><span class="o">:</span> <span class="p">{</span> <span class="nx">click</span><span class="o">:</span> <span class="s1">&#39;onTimeZoneClick()&#39;</span> <span class="p">}</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="kr">export</span> <span class="kr">class</span> <span class="nx">TimeZone</span><span class="p">{</span>
</span><span class='line'>    <span class="nx">constructor</span><span class="p">(){</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;TimeZone constructed&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">onTimeZoneClick</span><span class="p">(){</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;time zone &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; was clicked!&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">active</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<div style="text-align:center; margin-bottom:20px;">
    <img src="/images/timezone/timezoneoutput_clickwithid.jpg" style="max-height: 250px">
</div>


<p>And just like that, we have an <code>id</code> property in our TimeZone directive that stores our time zone id.  But we also want to show the visual state to our users. Ideally, when a time zone is selected, it would be highlighted on our map.  The easiest way would be to add a class based on the state of the component.  But again, since we can&rsquo;t modify the SVG template, we can&rsquo;t add a class directive to do it for us.  So how can we add a class to the host element?  Are we back to injecting the NgElement into the component?</p>

<p>Fortunately, no.  The answer comes by means of a <code>PropertySetter</code>.  A <code>PropertySetter</code> is an object that can be injected into our directive instance and allows us to modify a property of the DOM element to which the component is bound.  In the case of modifying classes, if we prefix our property name with &ldquo;class.&rdquo;, we have a neat shortcut that will add/remove the class whenever the property is set to true or false.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">Decorator</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;angular2/angular2&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">import</span> <span class="p">{</span><span class="nx">PropertySetter</span><span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;angular2/src/core/annotations/di&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="err">@</span><span class="nx">Decorator</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">selector</span><span class="o">:</span> <span class="s1">&#39;[data-tz-id]&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">bind</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;id&quot;</span> <span class="o">:</span> <span class="s2">&quot;data-tz-id&quot;</span> <span class="p">},</span>
</span><span class='line'>    <span class="nx">events</span><span class="o">:</span> <span class="p">{</span> <span class="nx">click</span><span class="o">:</span> <span class="s1">&#39;onTimeZoneClick()&#39;</span> <span class="p">}</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="kr">export</span> <span class="kr">class</span> <span class="nx">TimeZone</span><span class="p">{</span>
</span><span class='line'>    <span class="nx">constructor</span><span class="p">(</span><span class="err">@</span><span class="nx">PropertySetter</span><span class="p">(</span><span class="s1">&#39;class.active&#39;</span><span class="p">)</span> <span class="nx">setClassProperty</span><span class="o">:</span><span class="nb">Function</span><span class="p">){</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;TimeZone constructed&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">setClassProperty</span> <span class="o">=</span> <span class="nx">setClassProperty</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">onTimeZoneClick</span><span class="p">(){</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;time zone &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; was clicked!&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">active</span> <span class="o">=</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">active</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">set</span> <span class="nx">active</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">value</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">_active</span><span class="p">){</span>
</span><span class='line'>            <span class="k">this</span><span class="p">.</span><span class="nx">setClassProperty</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
</span><span class='line'>            <span class="k">this</span><span class="p">.</span><span class="nx">_active</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">get</span> <span class="nx">active</span><span class="p">(){</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_active</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<hr style="margin-bottom:20px;">


<p><strong>&mdash;Author Injection&mdash;</strong> And&hellip; <code>PropertySetter</code> syntax has been changed as well.  I&rsquo;ll update the code soon.</p>

<hr style="margin-bottom:30px;">


<p>With the <code>PropertySetter</code> now configured, we should be able to see the <code>active</code> class get toggled on our SVG timezone path whenever we click on a timezone.</p>

<div style="text-align:center; margin-bottom:20px;">
    <img src="/images/timezone/active_class_added.jpg" style="max-height: 250px">
</div>


<p>Okay, that seems to be working.  But we still can&rsquo;t visually see the state change.  We need to assign some visual significance to the <code>active</code> class.  This is probably a good time to take a step back and do some quick initial styling of our component.</p>

<h3>Some Quick Styling</h3>

<p>Let&rsquo;s take a quick break from all of this new Angular2, and put in some quick CSS so that we can see when a timezone is selected.  We already have a small style block In <code>index.html</code> that we used to set our timezone fill to transparent.  We&rsquo;ll tweak it to include a few more styles.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;style </span><span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">path</span><span class="p">{</span>
</span><span class='line'>    <span class="n">stroke</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">path</span><span class="o">[</span><span class="nt">data-tz-id</span><span class="o">]</span><span class="p">{</span>
</span><span class='line'>    <span class="o">-</span><span class="n">webkit</span><span class="o">-</span><span class="n">transition</span><span class="o">:</span> <span class="n">all</span> <span class="m">200</span><span class="n">ms</span> <span class="n">ease</span><span class="o">-</span><span class="n">in</span><span class="o">-</span><span class="n">out</span><span class="p">;</span>
</span><span class='line'>    <span class="o">-</span><span class="n">moz</span><span class="o">-</span><span class="n">transition</span><span class="o">:</span> <span class="n">all</span> <span class="m">200</span><span class="n">ms</span> <span class="n">ease</span><span class="o">-</span><span class="n">in</span><span class="o">-</span><span class="n">out</span><span class="p">;</span>
</span><span class='line'>    <span class="n">transition</span><span class="o">:</span> <span class="n">all</span> <span class="m">200</span><span class="n">ms</span> <span class="n">ease</span><span class="o">-</span><span class="n">in</span><span class="o">-</span><span class="n">out</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">pointer</span><span class="o">-</span><span class="n">events</span><span class="o">:</span> <span class="n">all</span><span class="p">;</span>
</span><span class='line'>    <span class="n">stroke</span><span class="o">-</span><span class="k">opacity</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">fill</span><span class="o">-</span><span class="k">opacity</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">stroke</span><span class="o">:</span> <span class="m">#99ccee</span><span class="p">;</span>
</span><span class='line'>    <span class="n">stroke</span><span class="o">-</span><span class="k">width</span><span class="o">:</span> <span class="m">1px</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">fill</span><span class="o">:</span> <span class="m">#99ccee</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">path</span><span class="o">[</span><span class="nt">data-tz-id</span><span class="o">]</span><span class="nc">.active</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">stroke</span><span class="o">-</span><span class="k">opacity</span><span class="o">:</span> <span class="m">1</span><span class="p">;</span>
</span><span class='line'>    <span class="n">fill</span><span class="o">-</span><span class="k">opacity</span><span class="o">:</span> <span class="o">.</span><span class="m">25</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nf">#land</span><span class="p">{</span>
</span><span class='line'>    <span class="n">fill</span><span class="o">:</span> <span class="m">#7D7F81</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="nt">&lt;/style&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<div style="text-align:center; margin-bottom:20px;">
    <img src="/images/timezone/active_timezone.jpg" style="max-height: 250px">
</div>


<p>Now we&rsquo;re getting somewhere.  We&rsquo;ll come back to tweak these styles one more time later (to jazz it up just a bit), but this should get us enough to test actual user interaction without looking at the DOM every time.</p>

<h3>Wrapping Up</h3>

<p>With all the topics that we&rsquo;ve covered already, now is probably as good a time as any to give our minds a well deserved rest.  Let&rsquo;s do a quick review of what we&rsquo;ve learned:</p>

<ol>
<li>Angular2 is still evolving, many things are still changing under the covers.</li>
<li>Our component will consist of three directives, TimeZonePicker, TimeZoneMap, and TimeZone.</li>
<li>There are three different directive annotations in Angular2, <code>@Decorator</code>, <code>@Component</code>, and <code>@Viewport</code>.  We use <code>@Decorator</code> and <code>@Component</code> for our directives.</li>
<li>ES6 syntax mixed with TypeScript is different, but neat.</li>
<li>Using directive annotations, we can get/set element properties and events without getting a direct reference to the DOM element.</li>
</ol>


<h3>Coming Up Next</h3>

<p>In part 3 of our series, we&rsquo;ll get into some of the really fun and interesting improvements of Angular2 over AngularJs (v1.x).  We&rsquo;ll discuss the four different dependency injection types, what they mean, and a few caveats of wiring everything up.  We&rsquo;ll also cover using <code>EventEmitter</code> to broadcast changes to consumers of our component.  Finally, we&rsquo;ll put the finishing touches on our component in order to prepare it for users.  It should be a good read.</p>

<p>Thanks for reading!  Follow on Twitter for updates on subsequent posts!</p>

<p>&mdash;T</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/01/building-an-angularjs-timezone-picker-part-1/">An Angular2 Timezone Picker - Part 1: Becoming a Kartograph-er</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-04-01T21:09:07-06:00" pubdate data-updated="true">Apr 1<span>st</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>TLDR</h3>

<p>We design an SVG map to serve as the basis of our Angular2 timezone picker.</p>

<p>Using Kartograph, we generate a viable map candidate using shape file obtained from the <a href="http://efele.net/maps/tz/world/">tz_world database</a> and <a href="http://www.naturalearthdata.com">Natural Earth Data</a>.</p>

<p>We optimize the map using Kartograph configurations in order to cut down size and add attribution.</p>

<h3>Introduction</h3>

<p>In this multi-part series, we&rsquo;ll be going through the process of building a timezone picker from scratch.  We&rsquo;ll talk through possible solutions and why we choose one route or the other.</p>

<p><strong>Disclosure:</strong> I am not an Angular2 expert.  At this point, I&rsquo;m not sure anyone is.  We&rsquo;ll be learning together as we go through this process.</p>

<p><strong>Disclosure 2:</strong> The first part of this series documents how to build the map for the component.  Subsequent posts will document the process of building the Angular2 code.  If you only care about Angular2, feel free to skip this and come back for the next.</p>

<h3>The Goal</h3>

<p>To keep this post as close to real life as possible, let assume we have no clue what we want to build (this has <em>never</em> happened to me, I promise). So let&rsquo;s just find a reliable implementation to copy.  The OSX timezone picker should work.</p>

<p><img src="/images/timezone/osx_picker.jpg" title="Yup.  We are going to copy this" alt="alt text" /></p>

<p>I fully acknowledge that I do not own copyrights to this picker, so we will get close to this, but not too close.  For the sake of simplicity we won&rsquo;t get into a full design spec.  But here is a short list of what we are aiming to accomplish:</p>

<ul>
<li>Map of the world continents (excluding Antarctica), shaded and filled</li>
<li>Highlight the timezone offset (not the timezone) on click</li>
<li>Display the name of the time zone that was clicked</li>
</ul>


<p>Bonus items:</p>

<ul>
<li>City lookup and reverse geo-coding (if you don&rsquo;t mind a server component)</li>
<li>Size independent</li>
<li>As small (kb-wise) as possible</li>
<li>As few external dependencies as possible (preferably none)</li>
</ul>


<p>Because this is quite the list of features, we&rsquo;ll implement it in phases.  For some of the trickier features, we&rsquo;ll hopefully be able to get by without a server.  We&rsquo;ll have to wait and see.  For phase 1, we&rsquo;ll simply allow for the selection of specific time zones.  In phase 2, we&rsquo;ll extend it to city searching by reverse-geocoding.</p>

<p><strong>Note:</strong> Our first instinct might be to check if someone else has done this for us already.  Great!  A quick good search reveals a few AngularJs pickers that already do much of what we want.  Luckily for us, none are in Angular2 (yet!)  Either way, that&rsquo;s no fun!  We need to do it ourselves.  If we didn&rsquo;t write it, it&rsquo;s crap.</p>

<h3>Our Custom Map</h3>

<p>First things first, let&rsquo;s get a map on which we can base our picker.  Building a viable SVG map will be the primary focus of this post.  To do so, we are going to use a nice set of Python scripts called <a href="http://kartograph.org/">Kartograph</a>.</p>

<p>Kartograph actually has two parts, Kartograph.py and Kartograph.js.  Kartograph.py is a Python library used to generate SVGs from GIS shape files.  Kartograph.js is a javascript library for displaying and manipulating Kartograph.py maps in the browser.  It does a great job, but in our case, we don&rsquo;t need to incur the cost of the extra library, so we won&rsquo;t use it.  So we&rsquo;ll just use Kartograph.py to generate ourselves a nice SVG.</p>

<p>A valid question at this point may be &ldquo;Why incur the cost of an SVG when an image will do just fine?&rdquo;.  Great question.  We&rsquo;ll see some good reasons in the future as we implement more features, but let&rsquo;s just say that we want the ultimate flexibilty.  Our component should be able to allow the selection of time zones in any bounded geographic area, not just for a hard-coded map.  Building our component around SVGs generated by Kartograph helps ensure users will be able to generate and use their own custom maps.</p>

<p>Other great reasons:</p>

<ul>
<li>Different Projections</li>
<li>User styling</li>
<li>Attribution</li>
</ul>


<p><strong>Tangent:</strong> I had a roommate in college who studied <a href="http://en.wikipedia.org/wiki/Geographic_information_system">GIS</a> and I never even realized how cool it was.  GIS deals with some interesting problems. Starting this component, I bet you didn&rsquo;t realize you&rsquo;d be learning GIS shape files, map projections, and reverse geo-coding.</p>

<h3>The Map Shapes</h3>

<p>If you haven&rsquo;t installed Kartograph.py.  Go ahead and <a href="http://kartograph.org/docs/kartograph.py/">do it now</a>.  You&rsquo;ll need it for this part.</p>

<p>To kick things off, we&rsquo;ll need some great shape (.shp) files to serve as the base for our map.  Like usual, the open source community saves us here.  For our picker, these are the shape files we will need:</p>

<ul>
<li><a href="http://www.naturalearthdata.com/downloads/50m-physical-vectors/50m-land/">Land Outlines &ndash; Natural Earth Data</a></li>
<li><a href="http://efele.net/maps/tz/world/">Timezone Boundaries &ndash; tz-world</a></li>
<li><a href="http://www.naturalearthdata.com/downloads/10m-cultural-vectors/timezones/">Timezone offsets &ndash; Natural Earth Data</a></li>
</ul>


<p>For phase 1, we&rsquo;ll only be using the first 2.  But if you&rsquo;re going to be around for the whole series, go ahead and download the last one as well.</p>

<p>If you want a free application that can view the .shp files before we turn them into SVGs, check out <a href="http://www.qgis.org/en/site/">QGIS</a>.</p>

<h3>Generating Our Map</h3>

<p>Alright, now for a crash course in using Kartograph.py.  In it&rsquo;s simplest form, Kartograph runs as a command line utility that accepts a configuration JSON file and generates an output SVG.  The configuration files can include many different settings.  Read the <a href="http://kartograph.org/docs/kartograph.py/">docs</a> to see them all.  We will use a subset while generating our map.</p>

<p>So let&rsquo;s take a first stab at a configuration file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;layers&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;land&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nt">&quot;src&quot;</span> <span class="p">:</span> <span class="s2">&quot;srcs/ne_110m_land.shp&quot;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>      <span class="nt">&quot;timezones&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nt">&quot;src&quot;</span> <span class="p">:</span> <span class="s2">&quot;srcs/tz_world.shp&quot;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;proj&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;lonlat&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This configuration specifies that we want 2 layers.  The &ldquo;land&rdquo; layer will come from the ne_110m_land.shp files, and the &ldquo;timezones&rdquo; layer will come from tz_world.shp.  We also specify the map projection to be &ldquo;lonlat&rdquo;.</p>

<p>You can think of <a href="http://en.wikipedia.org/wiki/Map_projection">map projections</a> as consistent ways of mapping the spherical latitude and longitude measurements to a 2d plane.  If that peaks your interest at all, read through the wiki page.  It&rsquo;s another interesting area of GIS.  The &ldquo;lonlat&rdquo; projection we are using is a linear interpolation algorithm that will make extracting lat/lng from our map much simpler when we implement reverse-geocoding.</p>

<p>So now that we have our configuration file setup,  we run Kartograph, and get our output SVG.  Let&rsquo;s open it up and take a look.  It looks great!  We&rsquo;ve got our continent outlines overlaid by our timezone outlines.  Perfect.</p>

<div style="text-align:center; margin-bottom:20px;">
  <img src="/images/timezone/step1_map.jpg">
</div>


<p>So I guess we&rsquo;re done!  Ship it!  Okay, not so fast.  That sure took a while to load and render in Chrome when I opened it.  What&rsquo;s going on?  Uh oh.  Finder adds some insight&hellip;</p>

<div style="text-align:center; margin-bottom:20px;">
    <img src="/images/timezone/step1_output.jpg" style="height: 250px">
</div>


<p>Ouch!  46 megs?!?  It&rsquo;s large enough the OSX won&rsquo;t even render a preview image.  That might work for my good friends down in Provo that run Google Fiber, but I&rsquo;m not so lucky.  Let&rsquo;s see what we can do to shrink it.</p>

<p>Taking a quick glance at the SVG code in an editor seems to indicate that the file size is due to the shear number of points necessary to represent each time zone boundary.  In other words, our SVG is simply too complex.  We have two options, eliminate shapes or simplify the geometry.  We&rsquo;ll try both.</p>

<h3>Optimizing For Size &ndash; Eliminate Shapes</h3>

<p>Scouring through the Kartograph docs, I noticed that there is a <a href="http://kartograph.org/docs/kartograph.py/#filtering-map-features">&ldquo;filter&rdquo; option</a> that can be used in our configuration to conditionally include geometries.  That seems to fit the ticket.  But what do we filter on?  Let&rsquo;s fire up QGIS and take a look.  Selecting a shape in tz_world shows us the attributes.</p>

<div style="text-align:center; margin-bottom:20px;">
    <img src="/images/timezone/attributes.jpg" style="height: 250px">
</div>


<p>There isn&rsquo;t much here, but we can make it work.  It seems like a good compromise would be to filter out extremely small time zones, as the likelihood of the user being able to even click those zones on the map is minuscule.  That may be upsetting for users in those specific time zones, but remember that this is phase 1.  If we want support for all possible time zones, we can address it in phase 2.  So lets change our configuration to filter out anything less than 3 sq km.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;layers&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;land&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nt">&quot;src&quot;</span> <span class="p">:</span> <span class="s2">&quot;srcs/ne_110m_land.shp&quot;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>      <span class="nt">&quot;timezones&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nt">&quot;src&quot;</span> <span class="p">:</span> <span class="s2">&quot;srcs/tz_world.shp&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="nt">&quot;filter&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;AREA&quot;</span><span class="p">,</span> <span class="s2">&quot;greater&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;proj&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;lonlat&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The result?  29.5 megs.  That&rsquo;s a pretty good decrease, but obviously still not good enough.  Let&rsquo;s take a look at our second option, simplifying the geometry.</p>

<h3>Optimizing For Size &ndash; Simplify Geometry</h3>

<p>The tz_world shape file has a pretty high resolution for it&rsquo;s boundary accuracy.  We definitely don&rsquo;t need that much accuracy on a map that is likely to be render at less than 1024px wide.  If we were printing a classroom map, maybe, but not for our purposes here.  We need a way to simplify the geometry without having to modify our shape files by hand.  Luckily, Kartograph can do <a href="http://kartograph.org/docs/kartograph.py/#simplifying-map-features">just that</a>.</p>

<p>By the way, put <a href="http://bost.ocks.org/mike/simplify/">Visvalingams algorithm</a> (how the simplification works) on the list of &ldquo;GIS things I didn&rsquo;t know existed that were created by very smart people&rdquo;.</p>

<p>Let&rsquo;s add the simplify option to our shape file layers.  The ne_110m_land.shp file already has 110m resolution, so we only need basic simplification there.  The tz_world layer, however, can do for a bit more.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;layers&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;land&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nt">&quot;src&quot;</span> <span class="p">:</span> <span class="s2">&quot;srcs/ne_110m_land.shp&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="nt">&quot;simplify&quot;</span> <span class="p">:</span> <span class="mi">1</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>      <span class="nt">&quot;timezones&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nt">&quot;src&quot;</span> <span class="p">:</span> <span class="s2">&quot;srcs/tz_world.shp&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="nt">&quot;filter&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;AREA&quot;</span><span class="p">,</span> <span class="s2">&quot;greater&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span class='line'>          <span class="nt">&quot;simplify&quot;</span> <span class="p">:</span> <span class="mi">3</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;proj&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;lonlat&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we&rsquo;re making real progress.  214 KB and the SVG still looks great.  Looks like simplification was the ticket.  However, we can still probably eek out a few more bytes.</p>

<h3>Optimizing For Size &ndash; Rounding for a few more bytes</h3>

<p>Examining the SVG code, you might notice that our paths are using very precise numbers for their points.  If we rounded the precision to the hundreth, we could probably shave a few more bytes without really affecting the shape of the geometry.  What&rsquo;s that?  Kartograph has the <a href="http://kartograph.org/docs/kartograph.py/#round-coordinates">round option</a>?  Let&rsquo;s plug it in.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;layers&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;land&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nt">&quot;src&quot;</span> <span class="p">:</span> <span class="s2">&quot;srcs/ne_110m_land.shp&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="nt">&quot;simplify&quot;</span> <span class="p">:</span> <span class="mi">1</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>      <span class="nt">&quot;timezones&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nt">&quot;src&quot;</span> <span class="p">:</span> <span class="s2">&quot;srcs/tz_world.shp&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="nt">&quot;filter&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;AREA&quot;</span><span class="p">,</span> <span class="s2">&quot;greater&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span class='line'>          <span class="nt">&quot;simplify&quot;</span> <span class="p">:</span> <span class="mi">3</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;proj&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;lonlat&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;export&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>     <span class="nt">&quot;round&quot;</span><span class="p">:</span> <span class="mi">1</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Perfect!  After all of our optimization, now we&rsquo;re down to a respectable 118 KB.  Much better.  But what is that monstrosity on the bottom of our map?  I&rsquo;m going to go ahead and make the assumption that if OSX doesn&rsquo;t include Antarctica on their map, we&rsquo;re safe to exclude it as well.  Now, we could just add another filter that explicitly excludes Antarctica from our SVG, but for learning sake, let&rsquo;s use bounding to do it instead.  <a href="http://kartograph.org/docs/kartograph.py/#framing-the-map">Bounds</a> allow us to specify the portion of the shape files that we actually want included in our SVG map.</p>

<h3>Optimizing Bounds</h3>

<p>In our case, we&rsquo;ll just be trimming off some of the southern hemisphere.  However, you could use this to isolate specific areas of the world for you own map.  And best of all, Kartograph includes metadata in the SVG that can be used to determine the lat/lng boundaries of the current map!  We&rsquo;ll be able to use this in phase 2 for simple lat/lng lookup based on mouse click location.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;layers&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;land&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nt">&quot;src&quot;</span> <span class="p">:</span> <span class="s2">&quot;srcs/ne_110m_land.shp&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="nt">&quot;simplify&quot;</span> <span class="p">:</span> <span class="mi">1</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>      <span class="nt">&quot;timezones&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nt">&quot;src&quot;</span> <span class="p">:</span> <span class="s2">&quot;srcs/tz_world.shp&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="nt">&quot;filter&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;AREA&quot;</span><span class="p">,</span> <span class="s2">&quot;greater&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span class='line'>          <span class="nt">&quot;simplify&quot;</span> <span class="p">:</span> <span class="mi">3</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;proj&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;lonlat&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;export&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>     <span class="nt">&quot;round&quot;</span><span class="p">:</span> <span class="mi">1</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;bounds&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;bbox&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">-180</span><span class="p">,</span> <span class="mi">-60</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">90</span><span class="p">]</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Overall, we&rsquo;re now down to 113 KB.  Gzipped, we&rsquo;re looking at 37 KB.  We&rsquo;re in JPG territory now, which is good enough for me.  We might be able to eek out a few more bytes, but we&rsquo;re probably at the point of diminishing returns.  Plus, 37KB is already so much more manageable than 46 megs.</p>

<div style="text-align:center; margin-bottom:20px;">
  <img src="/images/timezone/step5_output.jpg" style="height: 250px">
</div>


<p>Our map looks much simpler now, and that is good.  Once we style it, we&rsquo;ll have a nice clean starting point for our component.</p>

<h3>Adding Timezone Attribution</h3>

<p>After all of our changes, however, we need to add one more configuration to our map before we finish.  For easy lookup, we need to know the Olson code of the timezone that the user is clicking.  Without doing a lat/lng lookup into a timezone database (we&rsquo;ll get to that in later phases), the easiest way to allow this is to add the attribute to each time zone SVG path.</p>

<p>Luckily, as was observed previously, our tz_world shape file has the Olson code as an attribute on each time zone shape.  So let&rsquo;s tweak our configuration to have Kartograph maintain that attribute.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;layers&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;land&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nt">&quot;src&quot;</span> <span class="p">:</span> <span class="s2">&quot;srcs/ne_110m_land.shp&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="nt">&quot;simplify&quot;</span> <span class="p">:</span> <span class="mi">1</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>      <span class="nt">&quot;timezones&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>          <span class="nt">&quot;src&quot;</span> <span class="p">:</span> <span class="s2">&quot;srcs/tz_world.shp&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="nt">&quot;filter&quot;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&quot;AREA&quot;</span><span class="p">,</span> <span class="s2">&quot;greater&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span class='line'>          <span class="nt">&quot;simplify&quot;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>          <span class="nt">&quot;attributes&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>              <span class="nt">&quot;tz_id&quot;</span><span class="p">:</span> <span class="s2">&quot;TZID&quot;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;proj&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;lonlat&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;export&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>     <span class="nt">&quot;round&quot;</span><span class="p">:</span> <span class="mi">1</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;bounds&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;bbox&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">-180</span><span class="p">,</span> <span class="mi">-60</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">90</span><span class="p">]</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Whew!  We made it!  We&rsquo;ve got an SVG that can serve as the starting point for our phase 1 implementation.  With the metadata we added, it increased the size just a bit, but it still clocks in at 39Kb gzipped.  Not bad.  In the next post, we&rsquo;ll style the SVG, and get our Angular2 component up and running.</p>

<p><strong>Spoiler Alert</strong> With reverse-geocoding, we won&rsquo;t actually need the tz-world layer, which turns out to be the heaviest of the layers.  We&rsquo;ll be able to cut this SVG down in phase 2.  So our SVG is likely to end up even smaller.</p>

<h3>Conclusion</h3>

<p>In the first part of our timezone picker series, we&rsquo;ve started the process towards our amazing Angular2 timezone picker by using Kartograph to generate an SVG map.  We optimized the size of the map by eliminating unnecessary geometry and simplifying preserved geometry.  We also added attribution to time zone for ease of timezone lookup.</p>

<p>In the next entry, we&rsquo;ll style our SVG make and write the Angular2 code to wire up the behaviors we want.</p>

<p>In future entries, we&rsquo;ll expand our implementation to phase 2, reverse-geocoding and city lookup.</p>

<p>Thanks for reading!  Follow on Twitter for subsequent posts.</p>

<p>&mdash;T</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/12/23/the-angularjs-promise-anti-pattern-that-makes-me-cry/">The AngularJs Promise Anti-Pattern That Makes Me Cry</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-23T11:57:37-07:00" pubdate data-updated="true">Dec 23<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>TLDR</h3>

<ul>
<li>Try to wrap any promise work in services.  Rarely should controllers do anything but consume promises.</li>
<li>Expose promises as return values of service calls instead of forcing callbacks as parameters.  This allows for multiple callbacks. (and much simpler code)</li>
<li>Setup callbacks as behaviors instead of global &ldquo;success&rdquo; or &ldquo;failure&rdquo;.  This allows for much easier chaining if necessary</li>
</ul>


<h3>The anti-pattern</h3>

<p>Asynchronous interactions in AngularJs are built on promises.  A <a href="http://andyshora.com/promises-angularjs-explained-as-cartoon.html">lot</a> <a href="http://markdalgleish.com/2013/06/using-promises-in-angularjs-views/">has</a> <a href="http://johnmunsch.com/2013/07/17/angularjs-services-and-promises/">been</a> <a href="https://egghead.io/lessons/angularjs-promises">said</a> on the subject of promises already.  So I won&rsquo;t cover their purpose extensively here.  Long story short, use them.</p>

<p>Sadly enough, the reasons for using promises are still widely misunderstood.  One pattern, in particular, I still see quite often with new users of promises.  I don&rsquo;t have a cool name for it, but if I did, it would be: &ldquo;The AngularJs promise anti-pattern that makes me cry.&rdquo;  But that&rsquo;s just because I&rsquo;m over-dramatic.</p>

<p>In general, I&rsquo;ve seen this pattern in the following form:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">caller</span><span class="p">(){</span>
</span><span class='line'>  <span class="nx">callee</span><span class="p">({},</span> <span class="kd">function</span><span class="p">(){},</span> <span class="kd">function</span><span class="p">(){});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">callee</span><span class="p">(</span><span class="nx">toSave</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">failure</span><span class="p">){</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">$http</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/place&quot;</span><span class="p">,</span> <span class="nx">toSave</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">promise</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">successData</span><span class="p">){</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nx">success</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">success</span><span class="p">(</span><span class="nx">successData</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">failure</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">errorData</span><span class="p">){</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="nx">failure</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">failure</span><span class="p">(</span><span class="nx">errorData</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So before I start a flame war on this one, I&rsquo;ll go ahead and say nothing is &ldquo;wrong&rdquo; with this code.  In some cases I would even argue that it is perfectly acceptable.  You can see that we are trying to separate concerns, abstract callbacks, and keep things as clean as possible.  However, using promises this way eliminates many of the reasons that promises exist in the first place.  How so?  Let&rsquo;s step through a scenario.</p>

<h3>Our initial code</h3>

<p>Let&rsquo;s say that we are working along one day, listening to our favorite Pandora station when our project manager comes and taps us on the shoulder.  &ldquo;We need a page that saves an item and then moves on to another page.&rdquo;, he says.  No problem.  Being savvy programmers (with little time), we whip up the following controller and service in a few minutes.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">//Page controller</span>
</span><span class='line'><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s2">&quot;app&quot;</span><span class="p">).</span><span class="nx">controller</span><span class="p">(</span><span class="s2">&quot;testCtrl&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$location</span><span class="p">,</span> <span class="nx">test</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Responds to click events on the save button</span>
</span><span class='line'><span class="cm">   * Saves the items and advances to the next page if successful</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="nx">$scope</span><span class="p">.</span><span class="nx">onSaveClick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">test</span><span class="p">.</span><span class="nx">saveItem</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">item</span><span class="p">,</span>
</span><span class='line'>      <span class="c1">//success callback</span>
</span><span class='line'>      <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>        <span class="nx">$scope</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//go to next page</span>
</span><span class='line'>        <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s2">&quot;/place1&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="c1">//error callback</span>
</span><span class='line'>      <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>        <span class="c1">//go to next page</span>
</span><span class='line'>        <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s2">&quot;/place2&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//Helper service</span>
</span><span class='line'><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s2">&quot;app&quot;</span><span class="p">).</span><span class="nx">service</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">saveItem</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">fail</span><span class="p">){</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">$http</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/item&quot;</span><span class="p">,</span> <span class="nx">item</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//wrap the callback in another callback, because that&#39;s the cool way</span>
</span><span class='line'>    <span class="nx">promise</span><span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">itemData</span><span class="p">){</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="nx">success</span><span class="p">){</span>
</span><span class='line'>          <span class="nx">success</span><span class="p">(</span><span class="nx">itemData</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//do it a different way here.  Because two ways is always better than one!</span>
</span><span class='line'>    <span class="nx">promise</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">fail</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">saveItem</span> <span class="o">:</span> <span class="nx">saveItem</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>And voila, a page that saves an item on button click.  It works as designed.  I&rsquo;m sure quite a few readers threw up in their mouths reading that code (I almost did as I wrote it).  We could easily point out a number of issues already with the way this is designed, but that&rsquo;s not the point of this exercise.  Let&rsquo;s step through piece by piece and see why this is bad.  Plus, I&rsquo;m still surprised how often I will go back and read my own code and find designs like this.  We all have bad days.</p>

<h3>Exposing the issues: Changing requirements</h3>

<p>Let&rsquo;s say that our project manager comes back and decides that the requirements have changed.  &ldquo;Customers are complaining about getting lost,&rdquo; he says.  &ldquo;We need to add a second button that saves the item but stays on the same page. We need to support both buttons.&rdquo;</p>

<p>Great, no problem.  We&rsquo;ll just make some minor tweaks to our controller to support this functionality.  We take a step back and look at our code.  Lets look at our plan of attack.</p>

<ul>
<li>Another event handler for &ldquo;update in place&rdquo; button clicks.</li>
<li>both handlers call the same save code.</li>
<li>only the first save should route to another page</li>
<li>both error callbacks do the same thing</li>
</ul>


<p>So we take a first stab at it.  And after a few iterations of refactoring, come out with the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">//Page controller</span>
</span><span class='line'><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s2">&quot;app&quot;</span><span class="p">).</span><span class="nx">controller</span><span class="p">(</span><span class="s2">&quot;testCtrl&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$location</span><span class="p">,</span> <span class="nx">test</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">commonUiLogic</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">$scope</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$scope</span><span class="p">.</span><span class="nx">onSaveClick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">test</span><span class="p">.</span><span class="nx">saveItem</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">item</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>      <span class="nx">commonUiLogic</span><span class="p">();</span>
</span><span class='line'>      <span class="c1">//go to next page</span>
</span><span class='line'>      <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s2">&quot;/place1&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>      <span class="c1">//go to next page</span>
</span><span class='line'>      <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s2">&quot;/place2&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$scope</span><span class="p">.</span><span class="nx">onUpdateInPlace</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">test</span><span class="p">.</span><span class="nx">saveItem</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">item</span><span class="p">,</span> <span class="nx">commonUiLogic</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>      <span class="c1">//go to next page</span>
</span><span class='line'>      <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s2">&quot;/place2&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//service left out for brevity</span>
</span></code></pre></td></tr></table></div></figure>


<p>All things considered, not too bad.  We have a &ldquo;commonUiLogic&rdquo; method that updates our UI for us in both cases.  We call the same service method for saving on both updates.  We are coding masters.</p>

<h3>Starting to feel the pain: Even more changing requirements</h3>

<p>But then it happens, our project manager comes over and tells us the requirements have changed again.  &ldquo;Red is too powerful.  We need more blue.  We need another button that saves, turns the text blue, and then goes to the next page&rdquo;.  Oh boy.  K.  Let&rsquo;s try this out.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s2">&quot;app&quot;</span><span class="p">).</span><span class="nx">controller</span><span class="p">(</span><span class="s2">&quot;testCtrl&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$location</span><span class="p">,</span> <span class="nx">test</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">commonUiLogic</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">$scope</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">turnTextBlue</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">$scope</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">textColor</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$scope</span><span class="p">.</span><span class="nx">onSaveClick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">test</span><span class="p">.</span><span class="nx">saveItem</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">item</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>      <span class="nx">commonUiLogic</span><span class="p">();</span>
</span><span class='line'>      <span class="c1">//go to next page</span>
</span><span class='line'>      <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s2">&quot;/place1&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>      <span class="c1">//go to next page</span>
</span><span class='line'>      <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s2">&quot;/place2&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$scope</span><span class="p">.</span><span class="nx">onUpdateInPlace</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">test</span><span class="p">.</span><span class="nx">saveItem</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">item</span><span class="p">,</span> <span class="nx">commonUiLogic</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>      <span class="c1">//go to next page</span>
</span><span class='line'>      <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s2">&quot;/place2&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$scope</span><span class="p">.</span><span class="nx">anotherButton</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">test</span><span class="p">.</span><span class="nx">saveItem</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">item</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>      <span class="nx">commonUiLogic</span><span class="p">();</span>
</span><span class='line'>      <span class="nx">turnTextBlue</span><span class="p">();</span>
</span><span class='line'>    <span class="p">},</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>      <span class="c1">//go to next page</span>
</span><span class='line'>      <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s2">&quot;/place2&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//service left out for brevity</span>
</span></code></pre></td></tr></table></div></figure>


<p>Alright, that was a relatively simple addition.  But we are beginning to see how these callbacks can quickly get out of hand.  Every new difference can cause pretty large refactoring, and it isn&rsquo;t as easy to share common code as it should be.</p>

<h3>There must be a better way</h3>

<p>So let&rsquo;s take a step back.  What if we had been a bit smarter in our original design of our controller and service.  Could we have made this implementation even simpler?  For brevity&rsquo;s sake, lets just jump to the final refactor on this one.  We need three buttons, changing background colors, changing font colors, and fancy routing.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">//Page controller</span>
</span><span class='line'><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s2">&quot;app&quot;</span><span class="p">).</span><span class="nx">controller</span><span class="p">(</span><span class="s2">&quot;testCtrl&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$location</span><span class="p">,</span> <span class="nx">test</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">goToPlace1</span><span class="p">(){</span>
</span><span class='line'>    <span class="c1">//go to next page</span>
</span><span class='line'>    <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s2">&quot;/place1&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">changeBackgroundToRed</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">$scope</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">changeTextToBlue</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">$scope</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">goToPlace2</span><span class="p">(){</span>
</span><span class='line'>    <span class="c1">//go to next page</span>
</span><span class='line'>    <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s2">&quot;/place2&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$scope</span><span class="p">.</span><span class="nx">onSaveClick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">test</span><span class="p">.</span><span class="nx">saveItem</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">item</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">changeBackgroundToRed</span><span class="p">)</span>
</span><span class='line'>                                   <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">goToPlace1</span><span class="p">)</span>
</span><span class='line'>                                   <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">goToPlace2</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$scope</span><span class="p">.</span><span class="nx">onUpdateInPlace</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">test</span><span class="p">.</span><span class="nx">saveItem</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">item</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">changeBackgroundToRed</span><span class="p">)</span>
</span><span class='line'>                                   <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">goToPlace2</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$scope</span><span class="p">.</span><span class="nx">anotherButton</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>    <span class="nx">test</span><span class="p">.</span><span class="nx">saveItem</span><span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">item</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">changeTextToBlue</span><span class="p">)</span>
</span><span class='line'>                                   <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">goToPlace1</span><span class="p">)</span>
</span><span class='line'>                                   <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">goToPlace2</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//Helper service</span>
</span><span class='line'><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s2">&quot;app&quot;</span><span class="p">).</span><span class="nx">service</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">saveItem</span><span class="p">(</span><span class="nx">item</span><span class="p">){</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">$http</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/item&quot;</span><span class="p">,</span> <span class="nx">item</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">saveItem</span> <span class="o">:</span> <span class="nx">saveItem</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Awww.  That&rsquo;s better.  Don&rsquo;t you feel lighter and happier?</p>

<p>Let&rsquo;s note the major differences in this original implementation.  First, the service now returns the promise directly, instead of wrapping it by passing in the success and failure callbacks.  We no longer have inline functions as callbacks.  In fact, we don&rsquo;t even categorize callbacks as &ldquo;success&rdquo; or &ldquo;failure.&rdquo;  Instead, they are behaviorally specified.  That way, we can chain each behavior in different combinations in order to get the deserved result per save request.  Overall, the readability of the code is greatly improved.  And with concise behavioral callbacks, unit testing will be a breeze.</p>

<h3>Minor changes, big impact</h3>

<p>The differences between the two implementations are subtle, and in many cases won&rsquo;t matter unless you are the third or fourth developer working in the codebase.  But in summary, some best practices around using promises include:</p>

<ul>
<li>Try to wrap any promise work in services.  Rarely should controllers do anything but consume promises.</li>
<li>Expose promises as return values of service calls instead of forcing callbacks.  This allows for multiple callbacks.</li>
<li>Setup callbacks as behaviors instead of global &ldquo;success&rdquo; or &ldquo;failure&rdquo;.  This allows for much easier chaining if necessary</li>
</ul>


<p>&mdash;T</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/12/07/a-blog/">A Blog</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-07T13:00:10-07:00" pubdate data-updated="true">Dec 7<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve never really had a good online personal presence.  I had a couple of blogs in college and high school, but most of the subject matter revolved around weird life events.  Hardly what I&rsquo;d call a &ldquo;professional&rdquo; presence.  Now, working at <a href="http://www.domo.com">Domo</a>, I work with a ton of amazing people.  Most of them have pretty substantial credibility.  They inspired me to get my presence known and out there.</p>

<p>This blog will serve as a dumping point for my day-to-day adventures, as well as fun tidbits I learn or discovery along the way.</p>

<p>I hope you enjoy the ride.</p>

<p>&mdash;T</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>

    </div>
  </div>
  <footer role="contentinfo"><ul>
  <li></li>
  
  <li>
    <a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a>
  </li>
  

  
  <li>
    <a href="https://plus.google.com/+TylerRussell85">Plus</a>
  </li>
  

  
  <li>
    <a href="https://twitter.com/te_russ">Twitter</a>
  </li>
  

  
  <li>
    <a href="https://github.com/terussell85">GitHub</a>
  </li>
  

  <li>
    Copyright &copy; 2015 - Tyler Russell -
    <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  </li>
</ul>
</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'theblogoftylerrussell';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
